#!/bin/bash

set -e

echo "KVM Machine autostart"
SCRIPT_DIR=$(dirname $(readlink -f $0))
source $SCRIPT_DIR/config-common

AUTOSTART_FILE=$VM_PREFIX/autostart
echo "READING $AUTOSTART_FILE"
if [ ! -e $AUTOSTART_FILE ]; then
	echo "ERROR: Machine Autostart missing"
	exit 1
fi

cat $AUTOSTART_FILE | while read VM; do

VMPATH="$VM_PREFIX/$VM"
if [ -e "$VMPATH" ]; then
	pid=$(cat $VMPATH/var/pid)
	if [ ! -e "/proc/$pid" ]; then
		$SCRIPT_DIR/boot $VM
	else
		echo $VM allready running
	fi
else 
	echo "Unkown VM: $VM"
fi

done
